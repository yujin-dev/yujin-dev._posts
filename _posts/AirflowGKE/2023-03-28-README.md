# Airflow on GKE

```bash
$ gcloud container clusters create airflow-cluster --machine-type n1-standard-4 --num-nodes 2 --region "asia-northeast3"
```

GKE cluster를 생성하는 중에 권한 관련해서 오류가 발생했다.

```bash
ERROR: (gcloud.container.clusters.create) ResponseError: code=400, message=Failed precondition when calling the ServiceConsumerManager: tenantmanager::185014: Consumer 706614987791 should enable service:container.googleapis.com before generating a service account.
com.google.api.tenant.error.TenantManagerException: Consumer should enable service:container.googleapis.com before generating a service account
```

현재 admin 계정으로 오류 발생한 서비스에 권한을 주었다.

```bash
$ gcloud services enable container.googleapis.com
```

다시 실행하니 cluster가 잘 생성되었다.

```bash
$ gcloud container clusters create airflow-cluster --machine-type n1-standard-4 --num-nodes 2 --region "asia-northeast3"
Default change: VPC-native is the default mode during cluster creation for versions greater than 1.21.0-gke.1500. To create advanced routes based clusters, please pass the `--no-enable-ip-alias` flag
Note: Your Pod address range (`--cluster-ipv4-cidr`) can accommodate at most 1008 node(s).
Creating cluster airflow-cluster in asia-northeast3... Cluster is being health-checked...⠏                                                                            
Creating cluster airflow-cluster in asia-northeast3... Cluster is being health-checked (master is healthy)...done.                                                    
Created [https://container.googleapis.com/v1/projects/innate-plexus-345505/zones/asia-northeast3/clusters/airflow-cluster].
To inspect the contents of your cluster, go to: https://console.cloud.google.com/kubernetes/workload_/gcloud/asia-northeast3/airflow-cluster?project=innate-plexus-345505
kubeconfig entry generated for airflow-cluster.
NAME             LOCATION         MASTER_VERSION   MASTER_IP     MACHINE_TYPE   NODE_VERSION     NUM_NODES  STATUS
airflow-cluster  asia-northeast3  1.21.9-gke.1002  34.64.205.88  n1-standard-4  1.21.9-gke.1002  6          RUNNING
```

airflow 네임스페이스를 생성한다.

```bash
$ kubectl create namespace airfl1. gke 클러스터를 생성하고  `airflow` namespace를 추가한다.
```

이후 airflow helm chart를 다운받아 구성하고 설정 부분은 수정하여 업데이트한다.

```bash
$ helm repo add apache-airflow https://airflow.apache.org
$ helm upgrade --install airflow apache-airflow/airflow -n airflow --debug

$ helm show values apache-airflow/airflow > values.yaml
( value.yaml 수정 )
$ helm upgrade --install airflow apache-airflow/airflow -n airflow -f values.yaml --debug
```

[Deploying Airflow on Google Kubernetes Engine with Helm](https://towardsdatascience.com/deploying-airflow-on-google-kubernetes-engine-with-helm-28c3d9f7a26b)

[Helm Chart for Apache Airflow - helm-chart Documentation](https://airflow.apache.org/docs/helm-chart/stable/index.html)