---
title: "21.07.16"
category: "til"
---

## [ PyPI ] `petl`
https://petl.readthedocs.io/en/stable/io.html

Python에서 ETL 라이브러리도 제공한다. files, databases, etc에서 tables를 read, write하는 기능이 존재한다.(Extract/Load)
...

---
## [ Docker ] 도커 설치
```sh
sudo apt update
sudo apt install apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
sudo apt update
apt-cache policy docker-ce
'''
docker-ce:
  설치: (없음)
  후보: 5:20.10.7~3-0~ubuntu-bionic
  버전 테이블:
     5:20.10.7~3-0~ubuntu-bionic 500
        500 https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages
     5:20.10.6~3-0~ubuntu-bionic 500
        500 https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages
     5:20.10.5~3-0~ubuntu-bionic 500
```
실행 결과 위에서 `설치:(없음)`으로 출력된 것은 아직 도커가 설치되지 않았단 뜻. 아래처럼 도커를 설치한다. 
```sh
sudo apt install docker-ce # 도커 설치
sudo systemctl status docker # 도커 작동 확인
''' 
 docker.service - Docker Application Container Engine
     Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
     Active: active (running) since Fri 2021-07-16 16:51:43 KST; 1min 0s ago
TriggeredBy: ● docker.socket
       Docs: https://docs.docker.com
   Main PID: 21899 (dockerd)
      Tasks: 17
     Memory: 44.1M
     CGroup: /system.slice/docker.service
...
```
sudo로 docker를 실행해야 하므로 권한을 부여한다.
```sh
sudo usermod -aG docker $USER
'''
-G: 새로운 그룹
-a: 다른 그룹에서 삭제 없이 G에 따른 사용자 추가
```
참고: https://blog.cosmosfarm.com/archives/248/%EC%9A%B0%EB%B6%84%ED%88%AC-18-04-%EB%8F%84%EC%BB%A4-docker-%EC%84%A4%EC%B9%98-%EB%B0%A9%EB%B2%95/

---

## [ PostgreSQL ] 도커로 설치
```console
$ sudo docker run -p 5432:5432 --name postgres -e POSTGRES_PASSWORD={password} -d postgres

nable to find image 'postgres:latest' locally
latest: Pulling from library/postgres
b4d181a07f80: Pull complete 
46ca1d02c28c: Pull complete 
a756866b5565: Pull complete 
36c49e539e90: Pull complete 
664019fbcaff: Pull complete 
727aeee9c480: Pull complete 
796589e6b223: Pull complete 
add1501eead6: Pull complete 
fdad1da42790: Pull complete 
8c60ea65a035: Pull complete 
ccdfdf5ee2b1: Pull complete 
a3e1e8e2882e: Pull complete 
a6032b436e45: Pull complete 
Digest: sha256:2b87b5bb55589540f598df6ec5855e5c15dd13628230a689d46492c1d433c4df
Status: Downloaded newer image for postgres:latest
3f80d6777eeb31ace20bab432fde8735c2681a8c362576e06ed32473a75e1c6d

$ sudo docer ps -a

CONTAINER ID   IMAGE      COMMAND                  CREATED              STATUS              PORTS                                       NAMES
3f80d6777eeb   postgres   "docker-entrypoint.s…"   About a minute ago   Up About a minute   0.0.0.0:5432->5432/tcp, :::5432->5432/tcp   postgres
```
컨테이너에 접속한다.
```console
$ docker exec -it postgres /bin/bash
```
접속하려는 서버 정보를 명시한다.
```sh
root@3f80d6777eeb:/ psql -U postgres
root@3f80d6777eeb:/ psql -h {host_name} -p 5432 -U postgres -d {db_name} 
```

해당 컨테이너를 다시 시작하려면
```console
$ docker run postgres 
```


## [ PostgreSQL ] 성능 분석 - pgbench
pgbench는 PostgreSQL에서 제공하는 Benchmark 툴이다. `SELECT`, `INSERT`, `UPDATE` 등 명령어를 조합해서 시뮬레이션하고 이를 초당 Transaction 횟수로 성능을 평가한다.
서버가 설치된 하드웨어 및 OS 환경에서 성능을 측정하며 postgresql.conf의 환경 변수 설정에 사용될 수 있다.

### pgbench 사용
1. 성능 측정을 위한 임시 DB 인스턴스 생성 : 임시 Table을 쉽게 정리하기 위해 DB instance를 생성한다.
```console
$ psql -h {host} -U postgres postgres
$ CREATE DATABASE pgbenchtest OWNER postgres;
$ pgbenchtest postgres
```
2. DB instance `pgbenchtest`에 테이블 생성
```console 
$ pgbench -h {host} -p 5432 -U postgres -i pgbenchtest
```

접속하여 `\dt`로 실행하면 생성된 테이블을 확인할 수 있다.
테이블 크기를 키우려면 `-s`로 tuple수를 배수만큼 늘린다. 아래의 경우 10배만큼 증가한다.
```console
$ pgbench -h {host} -p 5432 -U postgres -i -s 10 pgbenchtest
```
3. 성능 테스트
벤치마킹 옵션을 적용하여 성능 테스트를 진행한다. 대표적으로
- `-c`: DB에 접속하는 가상의 client수
- `-j`: client를 thread 몇 개로 동작할 것인지(`-c`에서 설정한 값 이상이어야 함)
- `-t`: 시뮬레이션할 transaction 수

8개의 client, 각 client가 10회의 transaction을 수행할 때(4개의 thread로 분산)
```console
$ pgbench -h {host} -p 5432 -U postgres -c 8 -j 4 -t 10 pgbenchtest
```

튜닝 시에 postgresql.conf 인자 변경 및 pgbench 수행을 반복해야 하는 번거로움이 있다. 여러 변수를 테스트하려면 테스트할 시나리오로 자동화 테스트를 진행해야 할 것 같다.

참고: https://browndwarf.tistory.com/52

---
